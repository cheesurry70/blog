#!/usr/bin/env node

require('shelljs/make')
require("colors")

config.silent = false
config.fatal = true

var ingen = require('ingen')
var options = ingen.config // `config` is taken by shelljs :(

target.build = function() {
  echo('### building site...'.grey)
  options.init()
  ingen.build()
}

target.preview = function() {
  echo('### previewing site on port 4000')
  options.init({env: 'dev'})
  ingen.serve()
}

target.deploy = function() {

  target.build()

  rm('-rf', '_tmp')
  mkdir('_tmp')
  cd('_tmp')

  echo('>>> Updating gh-pages branch'.grey)
  exec('git init')
  exec('git remote add origin git@github.com:philipwalton/blog.git')
  exec('git pull origin gh-pages')
  rm('-rf', './*')
  cp('-Rf', '../_site/', './')
  exec('git add -A')
  exec('git commit -m "Deploy site."')
  exec('git branch -m gh-pages')
  exec('git push origin gh-pages')
  cd('..')

  echo(">>> Cleaning up".grey)
  rm('-rf', '_site')
  rm('-rf', '_tmp')

  echo("*** Successfully deployed site!".green)
}
